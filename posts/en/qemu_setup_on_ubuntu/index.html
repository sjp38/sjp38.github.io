<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Build, Install, and Use QEMU on Ubuntu | hacklog</title>
<meta name=keywords content="qemu,kvm,tips,virtualization,setup"><meta name=description content="This post describes how you can build, install, and use QEMU on an Ubuntu machine. I basically refererenced http://wiki.qemu.org/Hosts/Linux. The test has proceeded on an Ubuntu 18.04 server machine.
QEMU Build sudo apt install libglib2.0-dev libfdt-dev libpixman-1-dev zlib1g-dev \ libgtk-3-dev git clone git://git.qemu-project.org/qemu.git cd qemu git checkout v4.2.0 mkdir -p $HOME/qemu.sandbox/bin cd $HOME/qemu.sandbox/bin ../../qemu/configure --enable-debug --enable-gtk time make -j143 ./x86_64-softmmu/qemu-system-x86_64 -L pc-bios Guest OS Install Get an Ubuntu server install image:"><meta name=author content="Me"><link rel=canonical href=https://sjp38.github.io/posts/en/qemu_setup_on_ubuntu/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://sjp38.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://sjp38.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://sjp38.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://sjp38.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://sjp38.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://sjp38.github.io/posts/en/qemu_setup_on_ubuntu/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Build, Install, and Use QEMU on Ubuntu"><meta property="og:description" content="This post describes how you can build, install, and use QEMU on an Ubuntu machine. I basically refererenced http://wiki.qemu.org/Hosts/Linux. The test has proceeded on an Ubuntu 18.04 server machine.
QEMU Build sudo apt install libglib2.0-dev libfdt-dev libpixman-1-dev zlib1g-dev \ libgtk-3-dev git clone git://git.qemu-project.org/qemu.git cd qemu git checkout v4.2.0 mkdir -p $HOME/qemu.sandbox/bin cd $HOME/qemu.sandbox/bin ../../qemu/configure --enable-debug --enable-gtk time make -j143 ./x86_64-softmmu/qemu-system-x86_64 -L pc-bios Guest OS Install Get an Ubuntu server install image:"><meta property="og:type" content="article"><meta property="og:url" content="https://sjp38.github.io/posts/en/qemu_setup_on_ubuntu/"><meta property="og:image" content="https://sjp38.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-12-12T00:46:05+01:00"><meta property="article:modified_time" content="2019-12-12T00:46:05+01:00"><meta property="og:site_name" content="hacklog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://sjp38.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Build, Install, and Use QEMU on Ubuntu"><meta name=twitter:description content="This post describes how you can build, install, and use QEMU on an Ubuntu machine. I basically refererenced http://wiki.qemu.org/Hosts/Linux. The test has proceeded on an Ubuntu 18.04 server machine.
QEMU Build sudo apt install libglib2.0-dev libfdt-dev libpixman-1-dev zlib1g-dev \ libgtk-3-dev git clone git://git.qemu-project.org/qemu.git cd qemu git checkout v4.2.0 mkdir -p $HOME/qemu.sandbox/bin cd $HOME/qemu.sandbox/bin ../../qemu/configure --enable-debug --enable-gtk time make -j143 ./x86_64-softmmu/qemu-system-x86_64 -L pc-bios Guest OS Install Get an Ubuntu server install image:"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://sjp38.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Posts","item":"https://sjp38.github.io/posts/en/"},{"@type":"ListItem","position":3,"name":"Build, Install, and Use QEMU on Ubuntu","item":"https://sjp38.github.io/posts/en/qemu_setup_on_ubuntu/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Build, Install, and Use QEMU on Ubuntu","name":"Build, Install, and Use QEMU on Ubuntu","description":"This post describes how you can build, install, and use QEMU on an Ubuntu machine. I basically refererenced http://wiki.qemu.org/Hosts/Linux. The test has proceeded on an Ubuntu 18.04 server machine.\nQEMU Build sudo apt install libglib2.0-dev libfdt-dev libpixman-1-dev zlib1g-dev \\ libgtk-3-dev git clone git://git.qemu-project.org/qemu.git cd qemu git checkout v4.2.0 mkdir -p $HOME/qemu.sandbox/bin cd $HOME/qemu.sandbox/bin ../../qemu/configure --enable-debug --enable-gtk time make -j143 ./x86_64-softmmu/qemu-system-x86_64 -L pc-bios Guest OS Install Get an Ubuntu server install image:","keywords":["qemu","kvm","tips","virtualization","setup"],"articleBody":"This post describes how you can build, install, and use QEMU on an Ubuntu machine. I basically refererenced http://wiki.qemu.org/Hosts/Linux. The test has proceeded on an Ubuntu 18.04 server machine.\nQEMU Build sudo apt install libglib2.0-dev libfdt-dev libpixman-1-dev zlib1g-dev \\ libgtk-3-dev git clone git://git.qemu-project.org/qemu.git cd qemu git checkout v4.2.0 mkdir -p $HOME/qemu.sandbox/bin cd $HOME/qemu.sandbox/bin ../../qemu/configure --enable-debug --enable-gtk time make -j143 ./x86_64-softmmu/qemu-system-x86_64 -L pc-bios Guest OS Install Get an Ubuntu server install image:\n$ wget http://releases.ubuntu.com/18.04/ubuntu-18.04.3-live-server-amd64.iso Make qcow2 format image file:\ncd .. $ ./bin/qemu-img create -f qcow2 qc2img 32G Formatting 'qc2img', fmt=qcow2 size=34359738368 encryption=off cluster_size=65536 lazy_refcounts=off refcount_bits=16 $ ls -alh total 830M drwxrwxr-x 3 sjpark sjpark 4.0K Jun 1 20:34 . drwxr-xr-x 28 sjpark sjpark 4.0K Jun 1 20:15 .. drwxrwxr-x 94 sjpark sjpark 12K Jun 1 20:19 bin -rw-r--r-- 1 sjpark sjpark 193K Jun 1 20:34 qc2img -rw-rw-r-- 1 sjpark sjpark 848M Feb 16 05:37 ubuntu-18.04.3-live-server-amd64.iso And, boot QEMU VM with the install image:\n$ sudo ./bin/x86_64-softmmu/qemu-system-x86_64 -m 8G -enable-kvm \\ -drive if=virtio,file=qc2img,cache=none \\ -cdrom ubuntu-18.04.3-live-server-amd64.iso If your session is connected with X, above command opens QEMU GUI for the booted VM. The VM will be booted with the Ubuntu server install image, as same as when you boot a machine with an install media. As usual, proceed the install of the Ubuntu server on the VM. This post will use ssh to connect to the VM. Install openssh pacakge while the install process.\nNow, you can boot your Ubuntu VM as below:\n$ sudo ./bin/x86_64-softmmu/qemu-system-x86_64 -m 20G -smp 32 -enable-kvm \\ -drive if=virtio,file=qc2img,cache=none \\ -net user,hostfwd=tcp::2242-:22 -net nic -nographic Because of the -nographic option, it will not give you GUI interface but shows Booting from Hard Disk... message only. But, the VM is booted well. You can ssh to the VM via the port, 2242.\n$ ssh localhost -p 2242 Connect Console to Terminal Let’s connect the VM’s console to the QEMU executing terminal. Modify the /etc/default/grub file’s GRUB_CMDLINE_LINUX_DEFAULT to have \"console=ttyS0 earlyprintk=ttyS0 ftrace_dump_on_oops\".\nYou may also want to show GRUB when boot. Comment out GRUB_TIMEOUT_STYLE=hidden, give none-zero value to GRUB_TIMEOUT=, and Uncomment GRUB_TERMINAL=console.\nFinally, commit the change by:\n$ sudo update-grub $ sudo shutdown -h now After this, if you start the VM again using the QEMU command, the terminal you executed the QEMU command will be connected with the console of the VM and will show boot log and login prompt.\nReturn to VM Monitor Console If you want to go back to the VM monitor console, which you have seen before connecting the QEMU executed terminal to the VM’s console, press Ctrl+a c. If you want to go back to the guest console again, press Ctrl+a c enter.\nReference: https://serverfault.com/questions/471719/how-to-start-qemu-directly-in-the-console-not-in-curses-or-sdl\nBoot with Kernel in Host You can boot the VM to use a kernel image in the file system of the host machine. If you want to keep your development environment on your host machine but use the QEMU as a test target device, this is useful. Give the path to the kernel image file via -kernel option and give the kernel parameter you want to use using -append option. For example:\n$ sudo ../qemu/build/x86_64-softmmu/qemu-system-x86_64 -m 2048 -smp 2 \\ -enable-kvm -drive if=virtio,file=debian.img,cache=none \\ -net user,hostfwd=tcp::2242-:22 -net nic -nographic \\ -kernel /linux.out/arch/x86/boot/bzImage \\ -append “root=/dev/vda1 console=ttyS0 earlyprintk=ttyS0 debug ignore_loglevel ftrace_dump_on_oops” For the root= in the kernel parameter, check which device file is mounted as the rootfs by the guest OS and use it.\nAlso, you cannot use modules built on the host in the VM, unless you send the module binary files into the VM. If you don’t want to do that, simply build the modules you need in static. For example, as this post uses the ssh, I statically built the ethernet driver.\nImage Resize The guest os disk might be full soon, if you configured it too small. You can enlarge the qcow2 image’s size as below:\n$ qemu-img resize qc2img +160G $ sudo apt install libguestfs-tools $ cp qc2img qc2img.bak $ sudo virt-resize --expand /dev/sda1 qc2img.bak qc2img $ sudo virt-resize --expand /dev/sda1 qc2img.bak qc2img [ 0.0] Examining qc2img.bak ◓ 25% ⟦▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒═════════════════════════════════════════════════════════════════════⟧ --:-- 100% ⟦▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒⟧ 00:00 ****** Summary of changes: /dev/sda1: This partition will be resized from 24.0G to 184.0G. The filesystem ext4 on /dev/sda1 will be expanded using the 'resize2fs' method. /dev/sda2: This partition will be left alone. ****** [ 49.9] Setting up initial partition table on qc2img [ 56.7] Copying /dev/sda1 100% ⟦▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒⟧ 00:00 [ 594.9] Copying /dev/sda2 100% ⟦▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒⟧ 00:00 100% ⟦▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒⟧ 00:00 [ 767.4] Expanding /dev/sda1 using the 'resize2fs' method Resize operation completed with no errors. Before deleting the old disk, carefully check that the resized disk boots and works correctly. $ $ $ ./bin/qemu-img info qc2img image: qc2img file format: qcow2 virtual size: 192G (206158430208 bytes) disk size: 32G cluster_size: 65536 Format specific information: compat: 1.1 lazy refcounts: false refcount bits: 16 corrupt: false $ $ $ virt-filesystems --long -h --all -a qc2img libguestfs: warning: current user is not a member of the KVM group (group ID 117). This user cannot access /dev/kvm, so libguestfs may run very slowly. It is recommended that you 'chmod 0666 /dev/kvm' or add the current user to the KVM group (you might need to log out and log in again). Name Type VFS Label MBR Size Parent /dev/sda1 filesystem ext4 - - 184G - /dev/sda2 filesystem unknown - - 1.0K - /dev/sda5 filesystem swap - - 8.0G - /dev/sda1 partition - - 83 184G /dev/sda /dev/sda2 partition - - 05 1.0K /dev/sda /dev/sda5 partition - - 82 8.0G /dev/sda /dev/sda device - - - 192G - After that, if you boot the guest VM again and check, you can use the enlarged space:\n$ df -h Filesystem Size Used Avail Use% Mounted on udev 9.7G 0 9.7G 0% /dev tmpfs 2.0G 8.6M 2.0G 1% /run /dev/vda1 181G 24G 149G 14% / tmpfs 9.8G 0 9.8G 0% /dev/shm tmpfs 5.0M 0 5.0M 0% /run/lock tmpfs 9.8G 0 9.8G 0% /sys/fs/cgroup tmpfs 2.0G 0 2.0G 0% /run/user/1000 Reference: https://fatmin.com/2016/12/20/how-to-resize-a-qcow2-image-and-filesystem-with-virt-resize/\nQCOW2 Image Mount You might want to access to the guest VM image directly from the host. It is available using qemu-nbd tool. For that, load the nbd kernel module and connect the qcow2 format VM image via qemu-nbd:\n$ cd qemu.sandbox $ sudo modprobe nbd max_part=8 $ sudo ./bin/qemu-nbd --connect=/dev/nbd0 ./qc2img.bak Now you can see the partitions in the image using fdisk as below:\n$ sudo fdisk -l /dev/nbd0 Disk /dev/nbd0: 192 GiB, 206158430208 bytes, 402653184 sectors Units: sectors of 1 * 512 = 512 bytes Sector size (logical/physical): 512 bytes / 512 bytes I/O size (minimum/optimal): 512 bytes / 512 bytes Disklabel type: dos Disk identifier: 0xe513ef69 Device Boot Start End Sectors Size Id Type /dev/nbd0p1 * 2048 385877631 385875584 184G 83 Linux /dev/nbd0p2 385877632 402650753 16773122 8G 5 Extended /dev/nbd0p5 385877634 402650753 16773120 8G 82 Linux swap / Solaris Mount a partition you want to access:\n$ sudo mount /dev/nbd0p1 ./mnt/ $ cd mnt/ $ ls bin etc initrd.img.old lib64 media proc sbin sys var boot home lib libx32 mnt root snap tmp vmlinuz dev initrd.img lib32 lost+found opt run srv usr vmlinuz.old If you are done, unmount and disconnect the device using qemu-nbd.\n$ sudo umount ./mnt $ sudo ./bin/qemu-nbd --disconnect /dev/nbd nbd0 nbd0p2 nbd1 nbd11 nbd13 nbd15 nbd3 nbd5 nbd7 nbd9 nbd0p1 nbd0p5 nbd10 nbd12 nbd14 nbd2 nbd4 nbd6 nbd8 $ sudo ./bin/qemu-nbd --disconnect /dev/nbd0 /dev/nbd0 disconnected $ ","wordCount":"1227","inLanguage":"en","image":"https://sjp38.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2019-12-12T00:46:05+01:00","dateModified":"2019-12-12T00:46:05+01:00","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://sjp38.github.io/posts/en/qemu_setup_on_ubuntu/"},"publisher":{"@type":"Organization","name":"hacklog","logo":{"@type":"ImageObject","url":"https://sjp38.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://sjp38.github.io/ accesskey=h title="hacklog (Alt + H)"><img src=https://sjp38.github.io/apple-touch-icon.png alt aria-label=logo height=35>hacklog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://sjp38.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://sjp38.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://sjp38.github.io/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://sjp38.github.io/files/resume_sjpark.pdf title=cv><span>cv</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://sjp38.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://sjp38.github.io/posts/>Posts</a>&nbsp;»&nbsp;<a href=https://sjp38.github.io/posts/en/>Posts</a></div><h1 class="post-title entry-hint-parent">Build, Install, and Use QEMU on Ubuntu</h1><div class=post-meta><span title='2019-12-12 00:46:05 +0100 +0100'>December 12, 2019</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;1227 words&nbsp;·&nbsp;Me&nbsp;|&nbsp;<a href=https://github.com/sjp38/sjp38.github.io/tree/master/src/content/posts/en/qemu_setup_on_ubuntu.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#connect-console-to-terminal>Connect Console to Terminal</a></li></ul></nav></div></details></div><div class=post-content><p>This post describes how you can build, install, and use QEMU on an Ubuntu
machine.
I basically refererenced <a href=http://wiki.qemu.org/Hosts/Linux>http://wiki.qemu.org/Hosts/Linux</a>.
The test has proceeded on an Ubuntu 18.04 server machine.</p><h1 id=qemu-build>QEMU Build<a hidden class=anchor aria-hidden=true href=#qemu-build>#</a></h1><pre tabindex=0><code>sudo apt install libglib2.0-dev libfdt-dev libpixman-1-dev zlib1g-dev \
		libgtk-3-dev
git clone git://git.qemu-project.org/qemu.git
cd qemu
git checkout v4.2.0
mkdir -p $HOME/qemu.sandbox/bin
cd $HOME/qemu.sandbox/bin
../../qemu/configure --enable-debug --enable-gtk
time make -j143
./x86_64-softmmu/qemu-system-x86_64 -L pc-bios
</code></pre><h1 id=guest-os-install>Guest OS Install<a hidden class=anchor aria-hidden=true href=#guest-os-install>#</a></h1><p>Get an Ubuntu server install image:</p><pre tabindex=0><code>$ wget http://releases.ubuntu.com/18.04/ubuntu-18.04.3-live-server-amd64.iso
</code></pre><p>Make qcow2 format image file:</p><pre tabindex=0><code>cd ..
$ ./bin/qemu-img create -f qcow2 qc2img 32G
Formatting &#39;qc2img&#39;, fmt=qcow2 size=34359738368 encryption=off cluster_size=65536 lazy_refcounts=off refcount_bits=16
$ ls -alh
total 830M
drwxrwxr-x  3 sjpark sjpark 4.0K Jun  1 20:34 .
drwxr-xr-x 28 sjpark sjpark 4.0K Jun  1 20:15 ..
drwxrwxr-x 94 sjpark sjpark  12K Jun  1 20:19 bin
-rw-r--r--  1 sjpark sjpark 193K Jun  1 20:34 qc2img
-rw-rw-r--  1 sjpark sjpark 848M Feb 16 05:37 ubuntu-18.04.3-live-server-amd64.iso
</code></pre><p>And, boot QEMU VM with the install image:</p><pre tabindex=0><code>$ sudo ./bin/x86_64-softmmu/qemu-system-x86_64 -m 8G -enable-kvm \
	-drive if=virtio,file=qc2img,cache=none \
	-cdrom ubuntu-18.04.3-live-server-amd64.iso
</code></pre><p>If your session is connected with X, above command opens QEMU GUI for the
booted VM.
The VM will be booted with the Ubuntu server install image, as same as when you
boot a machine with an install media.
As usual, proceed the install of the Ubuntu server on the VM.
This post will use ssh to connect to the VM. Install openssh pacakge while the
install process.</p><p>Now, you can boot your Ubuntu VM as below:</p><pre tabindex=0><code>$ sudo ./bin/x86_64-softmmu/qemu-system-x86_64 -m 20G -smp 32 -enable-kvm \
	-drive if=virtio,file=qc2img,cache=none \
	-net user,hostfwd=tcp::2242-:22 -net nic -nographic
</code></pre><p>Because of the <code>-nographic</code> option, it will not give you GUI interface but
shows <code>Booting from Hard Disk...</code> message only. But, the VM is booted well.
You can ssh to the VM via the port, 2242.</p><pre tabindex=0><code>$ ssh localhost -p 2242
</code></pre><h2 id=connect-console-to-terminal>Connect Console to Terminal<a hidden class=anchor aria-hidden=true href=#connect-console-to-terminal>#</a></h2><p>Let&rsquo;s connect the VM&rsquo;s console to the QEMU executing terminal.
Modify the <code>/etc/default/grub</code> file&rsquo;s <code>GRUB_CMDLINE_LINUX_DEFAULT</code> to have
<code>"console=ttyS0 earlyprintk=ttyS0 ftrace_dump_on_oops"</code>.</p><p>You may also want to show GRUB when boot. Comment out
<code>GRUB_TIMEOUT_STYLE=hidden</code>, give none-zero value to <code>GRUB_TIMEOUT=</code>, and
Uncomment <code>GRUB_TERMINAL=console</code>.</p><p>Finally, commit the change by:</p><pre tabindex=0><code>$ sudo update-grub
$ sudo shutdown -h now
</code></pre><p>After this, if you start the VM again using the QEMU command, the terminal you
executed the QEMU command will be connected with the console of the VM and will
show boot log and login prompt.</p><h1 id=return-to-vm-monitor-console>Return to VM Monitor Console<a hidden class=anchor aria-hidden=true href=#return-to-vm-monitor-console>#</a></h1><p>If you want to go back to the VM monitor console, which you have seen before
connecting the QEMU executed terminal to the VM&rsquo;s console, press <code>Ctrl+a c</code>.
If you want to go back to the guest console again, press <code>Ctrl+a c enter</code>.</p><p>Reference:
<a href=https://serverfault.com/questions/471719/how-to-start-qemu-directly-in-the-console-not-in-curses-or-sdl>https://serverfault.com/questions/471719/how-to-start-qemu-directly-in-the-console-not-in-curses-or-sdl</a></p><h1 id=boot-with-kernel-in-host>Boot with Kernel in Host<a hidden class=anchor aria-hidden=true href=#boot-with-kernel-in-host>#</a></h1><p>You can boot the VM to use a kernel image in the file system of the host
machine.
If you want to keep your development environment on your host machine but use
the QEMU as a test target device, this is useful.
Give the path to the kernel image file via <code>-kernel</code> option and give the kernel
parameter you want to use using <code>-append</code> option.
For example:</p><pre tabindex=0><code>$ sudo ../qemu/build/x86_64-softmmu/qemu-system-x86_64 -m 2048 -smp 2 \
	-enable-kvm -drive if=virtio,file=debian.img,cache=none \
	-net user,hostfwd=tcp::2242-:22 -net nic -nographic \
	-kernel /linux.out/arch/x86/boot/bzImage \
	-append “root=/dev/vda1 console=ttyS0 earlyprintk=ttyS0 debug ignore_loglevel ftrace_dump_on_oops”
</code></pre><p>For the <code>root=</code> in the kernel parameter, check which device file is mounted as
the rootfs by the guest OS and use it.</p><p>Also, you cannot use modules built on the host in the VM, unless you send the
module binary files into the VM.
If you don&rsquo;t want to do that, simply build the modules you need in static. For
example, as this post uses the <code>ssh</code>, I statically built the ethernet driver.</p><h1 id=image-resize>Image Resize<a hidden class=anchor aria-hidden=true href=#image-resize>#</a></h1><p>The guest os disk might be full soon, if you configured it too small.
You can enlarge the qcow2 image&rsquo;s size as below:</p><pre tabindex=0><code>$ qemu-img resize qc2img +160G
$ sudo apt install libguestfs-tools
$ cp qc2img qc2img.bak
$ sudo virt-resize --expand /dev/sda1 qc2img.bak qc2img
$ sudo virt-resize --expand /dev/sda1 qc2img.bak qc2img
[   0.0] Examining qc2img.bak
◓ 25% ⟦▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒═════════════════════════════════════════════════════════════════════⟧ --:--
 100% ⟦▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒⟧ 00:00
******

Summary of changes:

/dev/sda1: This partition will be resized from 24.0G to 184.0G.  The
filesystem ext4 on /dev/sda1 will be expanded using the &#39;resize2fs&#39; method.

/dev/sda2: This partition will be left alone.

******
[  49.9] Setting up initial partition table on qc2img
[  56.7] Copying /dev/sda1
 100% ⟦▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒⟧ 00:00
[ 594.9] Copying /dev/sda2
 100% ⟦▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒⟧ 00:00
 100% ⟦▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒⟧ 00:00
[ 767.4] Expanding /dev/sda1 using the &#39;resize2fs&#39; method

Resize operation completed with no errors.  Before deleting the old disk,
carefully check that the resized disk boots and works correctly.
$
$
$ ./bin/qemu-img info qc2img
image: qc2img
file format: qcow2
virtual size: 192G (206158430208 bytes)
disk size: 32G
cluster_size: 65536
Format specific information:
    compat: 1.1
    lazy refcounts: false
    refcount bits: 16
    corrupt: false
$ 
$
$ virt-filesystems --long -h --all -a qc2img
libguestfs: warning: current user is not a member of the KVM group (group ID 117). This user cannot access /dev/kvm, so libguestfs may run very slowly. It is recommended that you &#39;chmod 0666 /dev/kvm&#39; or add the current user to the KVM group (you might need to log out and log in again).
Name       Type        VFS      Label  MBR  Size  Parent
/dev/sda1  filesystem  ext4     -      -    184G  -
/dev/sda2  filesystem  unknown  -      -    1.0K  -
/dev/sda5  filesystem  swap     -      -    8.0G  -
/dev/sda1  partition   -        -      83   184G  /dev/sda
/dev/sda2  partition   -        -      05   1.0K  /dev/sda
/dev/sda5  partition   -        -      82   8.0G  /dev/sda
/dev/sda   device      -        -      -    192G  -
</code></pre><p>After that, if you boot the guest VM again and check, you can use the enlarged
space:</p><pre tabindex=0><code>$ df -h
Filesystem      Size  Used Avail Use% Mounted on
udev            9.7G     0  9.7G   0% /dev
tmpfs           2.0G  8.6M  2.0G   1% /run
/dev/vda1       181G   24G  149G  14% /
tmpfs           9.8G     0  9.8G   0% /dev/shm
tmpfs           5.0M     0  5.0M   0% /run/lock
tmpfs           9.8G     0  9.8G   0% /sys/fs/cgroup
tmpfs           2.0G     0  2.0G   0% /run/user/1000
</code></pre><p>Reference:
<a href=https://fatmin.com/2016/12/20/how-to-resize-a-qcow2-image-and-filesystem-with-virt-resize/>https://fatmin.com/2016/12/20/how-to-resize-a-qcow2-image-and-filesystem-with-virt-resize/</a></p><h1 id=qcow2-image-mount>QCOW2 Image Mount<a hidden class=anchor aria-hidden=true href=#qcow2-image-mount>#</a></h1><p>You might want to access to the guest VM image directly from the host.
It is available using <code>qemu-nbd</code> tool.
For that, load the <code>nbd</code> kernel module and connect the qcow2 format VM image
via <code>qemu-nbd</code>:</p><pre tabindex=0><code>$ cd qemu.sandbox
$ sudo modprobe nbd max_part=8
$ sudo ./bin/qemu-nbd --connect=/dev/nbd0 ./qc2img.bak
</code></pre><p>Now you can see the partitions in the image using <code>fdisk</code> as below:</p><pre tabindex=0><code>$ sudo fdisk -l /dev/nbd0
Disk /dev/nbd0: 192 GiB, 206158430208 bytes, 402653184 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0xe513ef69

Device      Boot     Start       End   Sectors  Size Id Type
/dev/nbd0p1 *         2048 385877631 385875584  184G 83 Linux
/dev/nbd0p2      385877632 402650753  16773122    8G  5 Extended
/dev/nbd0p5      385877634 402650753  16773120    8G 82 Linux swap / Solaris
</code></pre><p>Mount a partition you want to access:</p><pre tabindex=0><code>$ sudo mount /dev/nbd0p1 ./mnt/
$ cd mnt/
$ ls
bin   etc         initrd.img.old  lib64       media  proc  sbin  sys  var
boot  home        lib             libx32      mnt    root  snap  tmp  vmlinuz
dev   initrd.img  lib32           lost+found  opt    run   srv   usr  vmlinuz.old
</code></pre><p>If you are done, <code>unmount</code> and disconnect the device using <code>qemu-nbd</code>.</p><pre tabindex=0><code>$ sudo umount ./mnt
$ sudo ./bin/qemu-nbd --disconnect /dev/nbd
nbd0    nbd0p2  nbd1    nbd11   nbd13   nbd15   nbd3    nbd5    nbd7    nbd9
nbd0p1  nbd0p5  nbd10   nbd12   nbd14   nbd2    nbd4    nbd6    nbd8
$ sudo ./bin/qemu-nbd --disconnect /dev/nbd0
/dev/nbd0 disconnected
$
</code></pre></div><footer class=post-footer><ul class=post-tags><li><a href=https://sjp38.github.io/tags/qemu/>Qemu</a></li><li><a href=https://sjp38.github.io/tags/kvm/>Kvm</a></li><li><a href=https://sjp38.github.io/tags/tips/>Tips</a></li><li><a href=https://sjp38.github.io/tags/virtualization/>Virtualization</a></li><li><a href=https://sjp38.github.io/tags/setup/>Setup</a></li></ul><nav class=paginav><a class=prev href=https://sjp38.github.io/posts/en/lkml_news_v5.5-rc3/><span class=title>« Prev</span><br><span>LKML News v5.5-rc3</span>
</a><a class=next href=https://sjp38.github.io/posts/ko/qemu_setup_on_ubuntu/><span class=title>Next »</span><br><span>Ubuntu 환경에서 QEMU 빌드 / 설치 / 사용하는 법</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Build, Install, and Use QEMU on Ubuntu on x" href="https://x.com/intent/tweet/?text=Build%2c%20Install%2c%20and%20Use%20QEMU%20on%20Ubuntu&amp;url=https%3a%2f%2fsjp38.github.io%2fposts%2fen%2fqemu_setup_on_ubuntu%2f&amp;hashtags=qemu%2ckvm%2ctips%2cvirtualization%2csetup"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Build, Install, and Use QEMU on Ubuntu on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fsjp38.github.io%2fposts%2fen%2fqemu_setup_on_ubuntu%2f&amp;title=Build%2c%20Install%2c%20and%20Use%20QEMU%20on%20Ubuntu&amp;summary=Build%2c%20Install%2c%20and%20Use%20QEMU%20on%20Ubuntu&amp;source=https%3a%2f%2fsjp38.github.io%2fposts%2fen%2fqemu_setup_on_ubuntu%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Build, Install, and Use QEMU on Ubuntu on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fsjp38.github.io%2fposts%2fen%2fqemu_setup_on_ubuntu%2f&title=Build%2c%20Install%2c%20and%20Use%20QEMU%20on%20Ubuntu"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Build, Install, and Use QEMU on Ubuntu on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fsjp38.github.io%2fposts%2fen%2fqemu_setup_on_ubuntu%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Build, Install, and Use QEMU on Ubuntu on whatsapp" href="https://api.whatsapp.com/send?text=Build%2c%20Install%2c%20and%20Use%20QEMU%20on%20Ubuntu%20-%20https%3a%2f%2fsjp38.github.io%2fposts%2fen%2fqemu_setup_on_ubuntu%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Build, Install, and Use QEMU on Ubuntu on telegram" href="https://telegram.me/share/url?text=Build%2c%20Install%2c%20and%20Use%20QEMU%20on%20Ubuntu&amp;url=https%3a%2f%2fsjp38.github.io%2fposts%2fen%2fqemu_setup_on_ubuntu%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Build, Install, and Use QEMU on Ubuntu on ycombinator" href="https://news.ycombinator.com/submitlink?t=Build%2c%20Install%2c%20and%20Use%20QEMU%20on%20Ubuntu&u=https%3a%2f%2fsjp38.github.io%2fposts%2fen%2fqemu_setup_on_ubuntu%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://sjp38.github.io/>hacklog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>