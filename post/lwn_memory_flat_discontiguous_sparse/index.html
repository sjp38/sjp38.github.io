<!DOCTYPE html>
<html lang="en-us">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="theme" content="hugo-academic">
  <meta name="generator" content="Hugo 0.31.1" />
  <meta name="author" content="SeongJae Park">
  <meta name="description" content="System Programmer">

  
  <link rel="alternate" hreflang="en-us" href="https://sjp38.github.io/post/lwn_memory_flat_discontiguous_sparse/">

  
  


  

  
  
  
  
    
  
  
    
    
      
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
      
    
  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha512-6MXa8B6uaO18Hid6blRMetEIoPqHf7Ux1tnyIQdpt9qI5OACx7C+O3IVTr98vwGnlcg0LOLa02i9Y1HpVhlfiw==" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.1/css/academicons.min.css" integrity="sha512-NThgw3XKQ1absAahW6to7Ey42uycrVvfNfyjqcFNgCmOCQ5AR4AO0SiXrN+8ZtYeappp56lk1WtvjVmEa+VR6A==" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha512-SfTiTlX6kk+qitfevl/7LibUOeJWlt9rbyDn92a1DqWOw9vWG2MFoays0sgObmWazO5BQPiFucnnEAjpAB+/Sw==" crossorigin="anonymous">
  
  
  
  
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Montserrat:400,700%7cRoboto:400,400italic,700%7cRoboto&#43;Mono">
  
  <link rel="stylesheet" href="/styles.css">
  

  
    <script>
      window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
      ga('create', 'UA-30621335-1', 'auto');
      ga('require', 'eventTracker');
      ga('require', 'outboundLinkTracker');
      ga('require', 'urlChangeTracker');
      ga('send', 'pageview');
    </script>
    <script async src="//www.google-analytics.com/analytics.js"></script>
    
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/autotrack/2.4.1/autotrack.js" integrity="sha512-HUmooslVKj4m6OBu0OgzjXXr+QuFYy/k7eLI5jdeEy/F4RSgMn6XRWRGkFi5IFaFgy7uFTkegp3Z0XnJf3Jq+g==" crossorigin="anonymous"></script>
    
  

  
  <link rel="alternate" href="https://sjp38.github.io/index.xml" type="application/rss+xml" title="Hacklog">
  <link rel="feed" href="https://sjp38.github.io/index.xml" type="application/rss+xml" title="Hacklog">
  

  <link rel="manifest" href="/site.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="https://sjp38.github.io/post/lwn_memory_flat_discontiguous_sparse/">

  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="og:site_name" content="Hacklog">
  <meta property="og:url" content="https://sjp38.github.io/post/lwn_memory_flat_discontiguous_sparse/">
  <meta property="og:title" content="Memory: the flat, the discontiguous, and the sparse (Korean) | Hacklog">
  <meta property="og:description" content="">
  <meta property="og:locale" content="en-us">
  
  <meta property="article:published_time" content="2019-07-31T07:45:17&#43;09:00">
  
  <meta property="article:modified_time" content="2019-07-31T07:45:17&#43;09:00">
  

  

  <title>Memory: the flat, the discontiguous, and the sparse (Korean) | Hacklog</title>

</head>
<body id="top" data-spy="scroll" data-target="#toc" data-offset="71" >

<nav class="navbar navbar-default navbar-fixed-top" id="navbar-main">
  <div class="container">

    
    <div class="navbar-header">
      
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
              data-target=".navbar-collapse" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
      <a class="navbar-brand" href="/">Hacklog</a>
    </div>

    
    <div class="collapse navbar-collapse">

      
      
      <ul class="nav navbar-nav navbar-right">
        

        

        
          
        

        <li class="nav-item">
          <a href="/#about">
            
            <span>Home</span>
            
          </a>
        </li>

        
        

        

        
          
        

        <li class="nav-item">
          <a href="/#publications_selected">
            
            <span>Publications</span>
            
          </a>
        </li>

        
        

        

        
          
        

        <li class="nav-item">
          <a href="/#posts">
            
            <span>Posts</span>
            
          </a>
        </li>

        
        

        

        
          
        

        <li class="nav-item">
          <a href="/#projects">
            
            <span>Projects</span>
            
          </a>
        </li>

        
        

        

        
          
        

        <li class="nav-item">
          <a href="/#contact">
            
            <span>Contact</span>
            
          </a>
        </li>

        
        

        

        
          
        

        <li class="nav-item">
          <a href="/#tags">
            
            <span>Tags</span>
            
          </a>
        </li>

        
        

        

        
          
        

        <li class="nav-item">
          <a href="/post/about/">
            
            <span>About</span>
            
          </a>
        </li>

        
        
      

      
      </ul>

    </div>
  </div>
</nav>


<article class="article" itemscope itemtype="http://schema.org/Article">

  


  <div class="article-container">
    <div class="article-inner">
      <h1 itemprop="name">Memory: the flat, the discontiguous, and the sparse (Korean)</h1>

      

<div class="article-metadata">

  <span class="article-date">
    
    <time datetime="2019-07-31 07:45:17 &#43;0900 KST" itemprop="datePublished">
      Jul 31, 2019
    </time>
  </span>

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    5 min read
  </span>
  

  
  

  
  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fa fa-folder"></i>
    
    <a href="/categories/lwn-translations">lwn translations</a
    >
    
  </span>
  
  

  
  
<div class="share-box" aria-hidden="true">
  <ul class="share">
    <li>
      <a class="twitter"
         href="https://twitter.com/intent/tweet?text=Memory%3a%20the%20flat%2c%20the%20discontiguous%2c%20and%20the%20sparse%20%28Korean%29&amp;url=https%3a%2f%2fsjp38.github.io%2fpost%2flwn_memory_flat_discontiguous_sparse%2f"
         target="_blank" rel="noopener">
        <i class="fa fa-twitter"></i>
      </a>
    </li>
    <li>
      <a class="facebook"
         href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fsjp38.github.io%2fpost%2flwn_memory_flat_discontiguous_sparse%2f"
         target="_blank" rel="noopener">
        <i class="fa fa-facebook"></i>
      </a>
    </li>
    <li>
      <a class="linkedin"
         href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fsjp38.github.io%2fpost%2flwn_memory_flat_discontiguous_sparse%2f&amp;title=Memory%3a%20the%20flat%2c%20the%20discontiguous%2c%20and%20the%20sparse%20%28Korean%29"
         target="_blank" rel="noopener">
        <i class="fa fa-linkedin"></i>
      </a>
    </li>
    <li>
      <a class="weibo"
         href="http://service.weibo.com/share/share.php?url=https%3a%2f%2fsjp38.github.io%2fpost%2flwn_memory_flat_discontiguous_sparse%2f&amp;title=Memory%3a%20the%20flat%2c%20the%20discontiguous%2c%20and%20the%20sparse%20%28Korean%29"
         target="_blank" rel="noopener">
        <i class="fa fa-weibo"></i>
      </a>
    </li>
    <li>
      <a class="email"
         href="mailto:?subject=Memory%3a%20the%20flat%2c%20the%20discontiguous%2c%20and%20the%20sparse%20%28Korean%29&amp;body=https%3a%2f%2fsjp38.github.io%2fpost%2flwn_memory_flat_discontiguous_sparse%2f">
        <i class="fa fa-envelope"></i>
      </a>
    </li>
  </ul>
</div>


  

</div>


      <div class="article-style" itemprop="articleBody">
        

<p>LWN 의 &ldquo;Memory: the flat, the discontiguous, and the sparse&rdquo; 라는 제목의 글의
한글 번역입니다.  원문은 LWN 에서 볼 수 있습니다:
<a href="https://lwn.net/Articles/789304/" target="_blank">https://lwn.net/Articles/789304/</a></p>

<p>Memory: the flat, the discontiguous, and the sparse
May 27, 2019</p>

<p>이 기사는 Mike Rapoport 에 의해 기여되었습니다.</p>

<p>컴퓨터 시스템에서 물리 메모리는 소중한 자원이어서, 이를 효율적으로 관리하기
위한 많은 노력이 기울여져왔습니다.
이 일은 현대의 시스템에서의 메모리 구조가 복잡해짐에 따라 더 어려워졌습니다.
물리 메모리가 실제로 어떻게 위치해 있는가를 다루기 위한 여러 계층의 추상화가
존재합니다; 그런 추상화 중 하나는 &ldquo;메모리 모델&rdquo; 이라고 불립니다.
커널은 세개의 모델을 지원하고 있는데, 그 중 하나는 지원이 멈춰져 가고 있습니다.
이 변경을 이해하기 위한 방법으로, 이 기사는 커널의 메모리 모델들의 진화, 현재
상태, 그리고 있을 법한 미래에 대해 자세히 들여다 봅니다.</p>

<h2 id="flatmem">FLATMEM</h2>

<p>리눅스가 처음 나왔을 때, 메모리는 평평했습니다: 메모리는 0 부터 수 메가바이트의
물리 주소를 갖는 단순한 선형적 배열일 뿐이었습니다.
각 물리 페이지 프레임은 커널의 <code>mem_map</code> 배열에 하나의 원소와 연관되었으며, 이
당시에 이 배열은 해당 페이지가 가진 레퍼런스의 갯수를 세는 하나의 <code>unsigned
short</code> 원소로 이루어져 있었습니다.
하지만, 얼마 있지 않아서, 이 <code>mem_map</code> 의 원소들은 스왑 관리를 위한 <code>age</code> 와
<code>dirty counter</code> 를 포함하도록 커졌습니다.
Linux 1.3.50 에서 <code>mem_map</code> 의 원소들은 마침내 <code>struct page</code> 로
이름지어졌습니다.</p>

<p>이 평평한 메모리 매핑은 물리 페이지 프레임 번호 (page-frame number : PFN) 와
그에 대응되는 <code>struct page</code> 사이의 쉽고 빠른 변환을 제공했습니다; 이 변환
작업은 간단한 배열 인덱스 계산 문제였습니다.
이후 <code>struct page</code> 의 레이아웃 변경이 있었는데, 새로운 사용처 (예컨대, page
cache) 들과 <code>struct page</code> 의 캐시 성능 최적화를 위한 것이었습니다.
메모리 매핑은 깔끔하고 효율적인 평평한 배열로 유지되었습니다만, 이는 중요한
단점을 가지고 있었습니다: 물리 주소 공간 상의 큰 공백을 처리할 수 없었습니다.
이 메모리 매핑 가운데 공백에 연관된 부분은 낭비되어지거나, ARM 에서처럼, 메모리
매핑 자체가 공백을 가질 수 있었습니다.</p>

<h2 id="discontigmem">DISCONTIGMEM</h2>

<p>상당히 비연속적인 물리 메모리를 효율적으로 처리하기 위한 지원이 리눅스를 NUMA
기계들 위에서 잘 동작하도록 하기 위한 노력의 일환으로 1999년에 메모리 관리
서브시스템으로 들어왔습니다.
이 코드는 <code>CONFIG_DISCONTIGMEM</code> 설정 옵션에 종속적이어서, 이 메모리 모델은
<code>DISCONTIGMEM</code> 이라 이름지어진 첫번째 모델이었습니다.</p>

<p>이 <code>DISCONTIGMEM</code> 모델은 메모리 노드 (memory node) 라는 개념을 소개했는데, 이
개념은 여전히 NUMA 메모리 관리의 기본으로 남아있습니다.
각 노드는 free-page lists, in-use page lists, least-recently-used (LRU) 정보,
사용 통계 등을 포함한, (대부분) 독립적인 메모리 관리 서브시스템을 갖습니다.
이런 것들 가운데, <code>struct pglist_data</code> (또는 짧게 <code>pg_data_t</code>) 로 표현되는 노드
데이터는 하나의 노드에 대한 메모리 매핑 정보를 가지고 있습니다.
각 노드가 연속적인 물리 메모리를 가지고 있다는 가정 하에, 노드당 하나의 <code>struct
page</code> 배열을 갖는 것은 평평한 메모리 매핑 안의 거대한 공백 문제를 해결했습니다.</p>

<p>하지만 이게 공짜로 된 건 아닙니다.
<code>DISCONTIGMEM</code> 에서는, 예를 들면 어떤 PFN 을 그에 연관된 <code>struct page</code> 로
변환하기 위해 특정 페이지를 어떤 노드가 가지고 있는지를 알 수 있어야 합니다.
비슷하게, 페이지를 가지고 PFN 을 구하기 위해 어떤 노드의 메모리 맵이 해당
<code>struct page</code> 를 가지고 있는지도 알 수 있어야 합니다.
긴 진화의 끝에, <code>KVADDR_TO_NID()</code>, <code>LOCAL_MAP_BASE()</code>, <code>ADDR_TO_MAPBASE()</code>,
그리고 <code>LOCAL_BASE_ADDR()</code> 매크로를 처음 정의한 <code>mips64</code> 부터 시작해서 PFN 의
<code>struct page</code> 로의 변환과 그 반대 작업은 <code>include/asm-generic/memory_model.h</code>
안에 정의된, 비교적 간단한 <code>pfn_to_page()</code> 와 <code>page_to_pfn()</code> 매크로로 수행되게
되었습니다.</p>

<p>하지만, DISCONTIGMEM 은 약점이 있었습니다: 메모리 핫플러그 (hotplug) 와
핫리무브 (hot remove) 입니다.
실제 NUMA 노드는 실제 핫플러그를 지원하기엔 너무 굵은 크기였고, 노드를 쪼개는
것은 불필요한게 많은 단편화와 오버헤드를 가져올 것이었습니다.
각 노드가 독립적인 메모리 관리 구조체들을 연관된 비용과 함께 가짐을 기억해
보세요; 노드를 쪼개는 것은 그런 비용을 상당히 증가시킬 겁니다.</p>

<h2 id="sparsemem">SPARSEMEM</h2>

<p>This limitation was resolved with the introduction of SPARSEMEM. This model
abstracted the memory map as a collection of sections of arbitrary size defined
by the architectures. Each section, represented by struct mem_section, is (as
described in the code): &ldquo;logically, a pointer to an array of struct pages.
However, it is stored with some other magic&rdquo;. The array of these sections is a
meta-memory map which can be efficiently chopped at SECTION_SIZE granularity.
For efficient conversion between a PFN and struct page, several high bits of
the PFN are used to index into the sections array. For the other direction, the
section number was encoded in the page flags.</p>

<p>A few months after its introduction into the Linux kernel, SPARSEMEM was
extended with SPARSEMEM_EXTREME, which is suitable for systems with an
especially sparse physical address space. SPARSEMEM_EXTREME added a second
dimension to the sections array and made this array, well, sparse. With
SPARSEMEM_EXTREME, the first level became pointers to mem_section structures,
and the actual mem_section objects were dynamically allocated based on the
actually populated physical memory.</p>

<p>Another enhancement to SPARSEMEM was added in 2007; it was called generic
virtual memmap support for SPARSEMEM, or SPARSEMEM_VMEMMAP. The idea behind
SPARSEMEM_VMEMMAP is that the entire memory map is mapped into a virtually
contiguous area, but only the active sections are backed with physical pages.
This model wouldn&rsquo;t work well with 32-bit systems, where the physical memory
size might approach or even exceed the virtual address space. However, for
64-bit systems SPARSEMEM_VMEMMAP is a clear win. At the cost of additional page
table entries, page_to_pfn(), and pfn_to_page() became as simple as with the
flat model.</p>

<p>The last extension of the SPARSEMEM memory model is more recent (2016); it was
driven by the increased use of persistent-memory devices. To support storing
the memory map directly on those devices rather than in main memory, the
virtual memory map can use struct vmem_altmap, which will provide page
structures in persistent memory.</p>

<p>Back in 2005, SPARSEMEM was described as a &ldquo;newer, and more experimental
alternative to &lsquo;discontiguous memory&rsquo;&ldquo;. The commit that added SPARSEMEM_VMEMMAP
noted that it &ldquo;has the potential to allow us to make SPARSEMEM the default (and
even the only) option for most systems&rdquo;. And indeed, several architectures have
switched over from DISCONTIGMEM to SPARSEMEM. In 2008, SPARSEMEM_VMEMMAP became
the only supported memory model for x86-64, as it was only slightly more
expensive than FLATMEM but more efficient than DISCONTIGMEM.</p>

<p>Recent memory-management developments, such as memory hotplug,
persistent-memory support, and various performance optimizations, all target
the SPARSEMEM model. But the older models still exist, which comes with the
cost of numerous #ifdef blocks in the architecture and memory-management code,
and a peculiar maze of related configuration options. There is an ongoing work
to completely switch the remaining users of DISCONTIGMEM to SPARSEMEM, but
making the change for such architectures as ia64 and mips64 won&rsquo;t be an easy
task. And the ARC architecture&rsquo;s use of DISCONTIGMEM to represent a &ldquo;high
memory&rdquo; area that resides below the &ldquo;normal&rdquo; memory will definitely be
challenging to change.</p>

      </div>

      


<div class="article-tags">
  
  <a class="btn btn-primary btn-outline" href="/tags/lwn">lwn</a>
  
  <a class="btn btn-primary btn-outline" href="/tags/linux">linux</a>
  
  <a class="btn btn-primary btn-outline" href="/tags/kernel">kernel</a>
  
  <a class="btn btn-primary btn-outline" href="/tags/memory-models">memory models</a>
  
  <a class="btn btn-primary btn-outline" href="/tags/translation">translation</a>
  
  <a class="btn btn-primary btn-outline" href="/tags/lwn-translations">lwn translations</a>
  
</div>



    </div>
  </div>

</article>



<div class="article-container article-widget">
  <div class="hr-light"></div>
  <h3>Related</h3>
  <ul>
    
    <li><a href="/post/lkml_news_v5.3-rc2/">LKML News v5.3-rc2</a></li>
    
    <li><a href="/post/lkml_news_v5.3-rc1/">LKML News v5.3-rc1</a></li>
    
    <li><a href="/post/lkml_news_v5.2/">LKML News v5.2</a></li>
    
    <li><a href="/post/lkml_news_v5.2-rc7/">LKML News v5.2-rc7</a></li>
    
    <li><a href="/post/lkml_news_v5.2-rc6/">LKML News v5.2-rc6</a></li>
    
  </ul>
</div>




<div class="article-container">
  

</div>

<footer class="site-footer">
  <div class="container">
    <p class="powered-by">

      &copy; 2017 Your Name &middot; 

      Powered by the
      <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
      <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

      <span class="pull-right" aria-hidden="true">
        <a href="#" id="back_to_top">
          <span class="button_icon">
            <i class="fa fa-chevron-up fa-2x"></i>
          </span>
        </a>
      </span>

    </p>
  </div>
</footer>


<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close btn-large" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Cite</h4>
      </div>
      <div>
        <pre><code class="modal-body tex"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-primary btn-outline js-copy-cite" href="#" target="_blank">
          <i class="fa fa-copy"></i> Copy
        </a>
        <a class="btn btn-primary btn-outline js-download-cite" href="#" target="_blank">
          <i class="fa fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

    

    
    

    

    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js" integrity="sha512-3P8rXCuGJdNZOnUx/03c1jOTnMn3rP63nBip5gOP2qmUh5YAdVAvFZ1E+QLZZbC1rtMrQb+mah3AfYW11RUrWA==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.3/imagesloaded.pkgd.min.js" integrity="sha512-umsR78NN0D23AzgoZ11K7raBD+R6hqKojyBZs1w8WvYlsI+QuKRGBx3LFCwhatzBunCjDuJpDHwxD13sLMbpRA==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha512-iztkobsvnjKfAtTNdHkGVjAYTrrtlC7mGp/54c40wowO7LhURYl3gVzzcEqGl/qKXQltJ2HwMrdLcNUdo+N/RQ==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.4/isotope.pkgd.min.js" integrity="sha512-VDBOIlDbuC4VWxGJNmuFRQ0Li0SKkDpmGyuhAG5LTDLd/dJ/S0WMVxriR2Y+CyPL5gzjpN4f/6iqWVBJlht0tQ==" crossorigin="anonymous"></script>
    
    
    <script src="/js/hugo-academic.js"></script>
    

    
    
      
      
      <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>
      

      

      

      <script>hljs.initHighlightingOnLoad();</script>
    

    
    

  </body>
</html>

